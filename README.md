# IpAddrCounter

Оригинал задания - https://github.com/Ecwid/new-job/blob/master/IP-Addr-Counter.md

Консольное приложение для подсчёта количества уникальных IPv4 адресов в файле. Программа разбивает файл на примерно
равные части и параллельно переводит строковые представления Ipv4 в int. Чтение каждого Ip адреса происходит
посимвольно, не создавая строк, а каждый объект IntIpBuilder переиспользуется для построения следующего адреса, что
снижает нагрузку на сборщик мусора. В качестве хранилища для полученных чисел выбраны два вектора битов (BitSet), один
для положительных чисел, другой для отрицательных.

Синхронизация добавления чисел каждым из читающих потоков выполнена внутренними буферами IntCounter (класса-обёртки над
векторами), которые получают потоки через ThreadLocal при добавлении каждого числа. При заполнении буфера поток
захватывает монитор объекта IntCounter и освобождает буфер записывая числа в векторы битов. Решение с буферами позволяет
уменьшить накладные расходы на захват монитора, если бы каждый поток синхронизировался при каждом добавлении числа.

Минимальные расходы памяти в хипе - 530 МБ для битовых векторов и 1.4 МБ на каждый читающий поток (1 МБ на байтовый
буфер для чтения и 400 КБ на каждый числовой буфер в хранилище). Количество потоков равно количеству логических
процессоров системы. Программа не предназначена для чтения с HDD из-за низкой производительности параллельного чтения.

Поддерживается построение нативного приложения GraalVM Native Image.

## Замеры производительности:

Замеры производились на следующих файлах:

| Количество строк | Уникальные адреса | Вес файла (GB) |
| ---- | ---- | ---- |
| 8000000 | 1000000 | 0.1 |
| 80000000 | 10000000 | 1 |
| 800000000 | 100000000 | 17 |
| 8000000000 | 1000000000 | 111 |

Скорость подсчёта и максимум занятой памяти процессом:

###### Windows 10, AMD Ryzen 7 1800X (8 ядер, 16 потоков), NVMe SSD

| Количество строк | GraalVM Native Image 17 21.3.0 | GraalVM 17 21.3.0 | OpenJDK 17
| ---- | ---- | ---- | ---- |
| 8000000 | 0.744 с | 1.108 с | 0.767 с
| 80000000 | 3.212 с | 2.704 с | 2.301 с
| 800000000 | 46 с | 17 с | 13 с
| 8000000000 | 5 м 19 с | 2 м 7 с | 1 м 27 с
|  | 573 MB | 762 MB | 620 MB

###### Ubuntu 20.04, Intel Core i7-3770K (4 ядра, 8 потоков)

| Количество строк | GraalVM Native Image 17 21.3.0 | GraalVM 17 21.3.0 | OpenJDK 17
| ---- | ---- | ---- | ---- |
| 8000000 | 0.848 с | 1.431 с | 0.854 с
| 80000000 | 6.145 с | 5.249 с | 4.319 с
| 800000000 | 1 м 25 с | 1 м 14 с | 1 м 7 с
| 8000000000 | 9 м 52 с | 7 м 43 с | 7 м 10 с
|  | 548 MB | 720 MB | 595 MB

### Сборка jar-файла

Для сборки артефакта требуется JDK 17+ и Maven. Для запуска требуется только JRE 17+ (входит в JDK).

```bash
mvn package
```

##### Использование

```bash
java -jar IpAddrCounter.jar "путь/к/файлу"
```

### Сборка Native Image

Для сборки требуется Maven, GraalVM 17+ и Native Image. Для Windows также требуется установка Visual Studio 2017 15.9+ и
запуск команды сборки из x64 Native Tools Command Prompt. Подробнее
- https://www.graalvm.org/reference-manual/native-image/

```bash
mvn package -P native
```

##### Использование

###### Linux

```bash
./IpAddrCounter "путь/к/файлу"
```

###### Windows

```bat
IpAddrCounter.exe "путь/к/файлу"
```